const onlineCountElement = document.getElementById('online-count');
const locationElement = document.getElementById('location');
const ipAddressElement = document.getElementById('ip-address');
var card = document.querySelector(".card");
document.addEventListener("DOMContentLoaded", function() {
    // 在页面加载完成后执行的代码

    // 发起 AJAX 请求
    $.ajax({
        url: '/Page/HomePage',
        type: 'GET',
        success: function (data, textStatus, jqXHR) {
            var creatToken = sessionStorage.getItem("creatToken");
            const formData = {
                PreysToken: creatToken
            };
            if (creatToken != null) {
                $.ajax({
                    url: '/api/Page/HomePage',
                    type: 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        // 解析成功后的处理
                        if (response.status == true) {
                            $('#current-user-info').text('当前用户：' + response.parsedToken).css('font-size', '18px');
                            $('#on line-count').text(response.onlinecount).css('font-size', '18px');
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // 解析失败的处理
                        console.log('令牌解析失败：', errorThrown);
                        // 在这里处理令牌解析失败的情况
                        $('#current-user-info').text('当前用户：未登录').css('font-size', '18px');

                    }
                });
            } else {
                alert("setCookieHeader：" + null);
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {
            // 请求失败的处理
        }
    });
    $(document).ready(function() {
        $('.form-container').addClass('collapsed');
    });

    $('.form-container').click(function() {
        $(this).toggleClass('collapsed');
    });

    // function addCardOnHover(elementId) {
    //     var currentUserInfo = document.getElementById(elementId);
    //
    //     var card = document.createElement("div");
    //     card.className = "card";
    //     card.style.display = "none";
    //     card.style.width = "80px";
    //     card.style.justifyContent = "flex-end"; // 设置卡片向右对齐
    //
    //     var logoutLink = document.createElement("a");
    //     logoutLink.href = "/logout";
    //     logoutLink.textContent = "退出登录";
    //     // 为退出登录链接添加点击事件监听器
    //     logoutLink.addEventListener("click", function(event) {
    //         event.preventDefault(); // 阻止默认链接行为
    //
    //         // 执行退出登录的AJAX请求
    //         logoutRequest();
    //         // 执行修改用户状态的AJAX请求
    //         updateStatusRequest();
    //     });
    //
    //     var profileLink = document.createElement("a");
    //     profileLink.href = "/profile";
    //     profileLink.textContent = "个人信息";
    //     // 为个人信息链接添加点击事件监听器
    //
    //     card.appendChild(logoutLink);
    //     card.appendChild(profileLink);
    //
    //     // 获取卡片的父容器
    //     var parentContainer = currentUserInfo.parentNode;
    //     // 设置父容器为相对定位
    //     parentContainer.style.position = "relative";
    //     // 添加适当的CSS样式，将卡片使用绝对定位，并放置在父容器的顶部
    //     card.style.position = "absolute";
    //     card.style.top = "40px";
    //
    //
    //
    //     currentUserInfo.addEventListener("mouseover", function() {
    //         card.style.display = "block";
    //     });
    //
    //     currentUserInfo.addEventListener("mouseout", function() {
    //         card.style.display = "none";
    //     });
    //
    //     currentUserInfo.appendChild(card);
    // }


    // 获取当前经纬度
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function (position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                locationElement.textContent = '经度: ' + longitude + '\n' + '纬度: ' + latitude;
            },
            function (error) {
                locationElement.textContent = '无法获取位置信息';
                console.log(error);
            }
        );
    } else {
        locationElement.textContent = '浏览器不支持地理位置功能';
    }

    // 获取电脑自身IP地址
    fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => {
            const ipAddress = data.ip;
            ipAddressElement.textContent = ipAddress;
        })
        .catch(error => {
            ipAddressElement.textContent = '无法获取IP地址';
            console.log(error);
        });
});
